{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Planta Milenio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <style>
        /* Mantener el footer en la parte inferior */
        html, body {
            height: 100%;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1 0 auto;
        }
        .footer {
            flex-shrink: 0;
        }
        .card-header.busqueda-header {
            background: var(--primary-dark);
            color: #fff !important;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .card-header.busqueda-header .fw-bold,
        .card-header.busqueda-header .small,
        .card-header.busqueda-header strong {
            color: #fff !important;
        }
        .btn-cargar-datos {
            background: #4da3ff !important;
            color: #fff !important;
            border: none;
        }
        .btn-cargar-datos:hover, .btn-cargar-datos:focus {
            background: #339cff !important;
            color: #fff !important;
        }
    </style>
</head>
<body>
    <!-- Navbar reducido solo a logo y título -->
    <header class="header">
        <div class="container header-wrapper d-flex justify-content-between align-items-center">
            <a href="{% url 'control' %}" class="logo d-flex align-items-center">
                <img src="{% static 'images/logo.png' %}" alt="Logo" style="height:50px; margin-right:10px;">
                Planta Milenio
            </a>
            <div id="venezuela-clock" class="fw-bold" style="font-size:1.2rem;">
                <i class="fa fa-clock"></i>
                <span id="clock-time"></span>
            </div>
            <div>
                <a href="{% url 'logout' %}" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt"></i> Cerrar sesión
                </a>
        </div>
    </header>

    <!-- Toast container -->
    <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080; min-width: 300px;">
        <div id="toast-container"></div>
    </div>

    <section class="section section-light main-content" style="padding-top: 120px;">
        <div class="container">
            <h2 class="section-title" style="font-size:2rem;"> Control de acceso planta milenio</h2>
            <div class="mb-3">
              <form method="get" class="row g-3 mb-4 search-box-sticky" id="consultaForm" autocomplete="off">
                <div class="col-md-4">
                    <input type="text" name="fact_num" class="form-control" placeholder="Número de orden" value="">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn w-100">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                <div class="col-md-3 d-flex align-items-center">
                    <div class="form-check form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="statusCondSwitch" name="status_cond" value="1">
                        <label class="form-check-label" for="statusCondSwitch">Condicional de estatus</label>
                    </div>
                </div>
              </form>
            </div>

            <!-- Mensajes como toast -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                {% if message %}
                    showToast("{{ message|escapejs }}", "info");
                {% endif %}
                {% if error %}
                    showToast("{{ error|escapejs }}", "danger");
                {% endif %}
                {% if messages %}
                    {% for m in messages %}
                        showToast("{{ m|escapejs }}", "{% if m.tags %}{{ m.tags }}{% else %}info{% endif %}");
                    {% endfor %}
                {% endif %}
            });
            </script>

            {% if registros and registros|length > 0 %}
                {% regroup registros by fact_num as fact_groups %}
                <div class="d-flex flex-column gap-4">
                {% for group in fact_groups %}
                    {% with first=group.list.0 %}
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center busqueda-header">
                            <div class="text-start w-100">
                                <strong>{{ first.prov_des }}</strong>
                                <div class="small">Fecha: {{ first.fec_emis|date:"m/d/Y" }}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">Orden: {{ group.grouper }}</div>
                                {% with orden_id=first.orden_id %}
                                    <div class="small">
                                        Orden en Romana:
                                        {% if orden_id %}
                                            {{ orden_id }}
                                        {% else %}
                                            <span class="text-warning">Orden no registrada</span>
                                        {% endif %}
                                    </div>
                                {% endwith %}
                                <div class="small">
                                    Status:
                                    {% if first.status|stringformat:"s" == "0" %}
                                        <span class="badge bg-secondary">Sin procesar</span>
                                    {% elif first.status|stringformat:"s" == "1" %}
                                        <span class="badge bg-warning text-dark">Semi procesado</span>
                                    {% elif first.status|stringformat:"s" == "2" %}
                                        <span class="badge bg-success">Procesado</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ first.status }}</span>
                                    {% endif %}
                                </div>
                                <button type="button"
                                    class="btn btn-cargar-datos mt-2 d-inline-flex align-items-center"
                                    style="white-space: nowrap;"
                                    onclick="handleCargarDatos('{{ first.status }}', 'validarModal{{ group.grouper }}')">
                                    <i class="fa fa-check-circle me-2"></i>Cargar datos
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Numero de orden</th>
                                            <th>Descripción</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-end">Uni Venta</th>
                                            <th class="text-end">Pendiente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for r in group.list %}
                                        <tr>
                                            <td>{{ r.fact_num }}</td>
                                            <td>{{ r.art_des|default:r.descrip }}</td>
                                            <td class="text-end">{{ r.total_art|cut:"%" }}</td>
                                            <td class="text-end">{{ r.uni_venta|cut:"%" }}</td>
                                            <td class="text-end">{{ r.pendiente|cut:"%" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Modal -->
                    <div class="modal fade" id="validarModal{{ group.grouper }}" tabindex="-1" aria-labelledby="validarModalLabel{{ group.grouper }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="validarModalLabel{{ group.grouper }}">Cargar datos de la Orden {{ group.grouper }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                </div>
                                <form method="post" action="" id="validarForm{{ group.grouper }}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <p>¿Desea cargar los datos de la orden <strong>{{ group.grouper }}</strong> del proveedor <strong>{{ first.prov_des }}</strong>?</p>
                                        <ul>
                                            <li><strong>Fecha:</strong> {{ first.fec_emis }}</li>
                                            <li><strong>Status:</strong> {{ first.status }}</li>
                                        </ul>
                                        <div class="mb-2">
                                            <label class="form-label">RIF de la Empresa de Transporte</label>
                                            <input type="text" name="empresa_rif" class="form-control" id="empresaRifInput{{ group.grouper }}" autocomplete="off" required>
                                            <div class="list-group position-absolute w-100" id="empresaRifList{{ group.grouper }}"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Cédula del Conductor</label>
                                            <input type="text" name="conductor" class="form-control" id="conductorInput{{ group.grouper }}" autocomplete="off" required>
                                            <div class="list-group position-absolute w-100" id="conductorList{{ group.grouper }}"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Placa del Vehículo</label>
                                            <input type="text" name="vehiculo" class="form-control" id="vehiculoInput{{ group.grouper }}" autocomplete="off" required>
                                            <div class="list-group position-absolute w-100" id="vehiculoList{{ group.grouper }}"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Placa del Remolque</label>
                                            <input type="text" name="vehiculo_remolque" class="form-control" id="remolqueInput{{ group.grouper }}" autocomplete="off">
                                            <div class="list-group position-absolute w-100" id="remolqueList{{ group.grouper }}"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Origen</label>
                                            <input type="text" name="destino" class="form-control" id="destinoInput{{ group.grouper }}" autocomplete="off" required>
                                            <div class="list-group position-absolute w-100" id="destinoList{{ group.grouper }}"></div>
                                        </div>
                                        <input type="hidden" name="validar_fact_num" value="{{ group.grouper }}">
                                        <input type="hidden" name="proveedor_id" value="{{ first.co_cli }}">
                                        <input type="hidden" name="proveedor_nombre" value="{{ first.prov_des }}">
                                        <input type="hidden" name="fecha_orden" value="{{ first.fec_emis }}">
                                        <input type="hidden" name="status" value="{{ first.status }}">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-success">Confirmar carga</button>
                                    </div>
                                <script>
                                    function setEmpresaRif{{ group.grouper }}(select) {
                                        var rif = select.options[select.selectedIndex].getAttribute('data-rif');
                                        document.getElementById('empresaRifInput{{ group.grouper }}').value = rif;
                                    }
                                </script>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
                </div>
            {% else %}
                <div class="card shadow-sm">
                    <div class="card-header busqueda-header">
                        <strong>Información de orden de compra</strong>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Numero de orden</th>
                                        <th>Descripción</th>
                                        <th class="text-end">Total</th>
                                        <th class="text-end">Uni Venta</th>
                                        <th class="text-end">Pendiente</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">En espera de consultas...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Historial de ingresos SIEMPRE visible -->
            <div class="card mt-5">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-history"></i> Historial de ingresos
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha y hora</th>
                                    <th>Número de orden</th>
                                    <th>Placa del vehículo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if historial and historial|length > 0 %}
                                    {% for h in historial %}
                                    <tr>
                                        <td>{{ h.fecha_hora|date:"m/d/Y H:i:s" }}</td>
                                        <td>{{ h.numero_orden }}</td>
                                        <td>{{ h.placa_vehiculo }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">No hay ingresos registrados.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="container mb-4 mt-2 d-flex justify-content-end">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reporteHistorialModal">
                    <i class="fas fa-file-pdf"></i> Descargar reporte de ingresos
                </button>
            </div>

            <!-- Modal para reporte de historial -->
            <div class="modal fade" id="reporteHistorialModal" tabindex="-1" aria-labelledby="reporteHistorialModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <form method="get" action="{% url 'reporte_historial' %}" target="_blank" class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="reporteHistorialModalLabel"><i class="fas fa-file-pdf"></i> Reporte de ingresos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                        <label for="fecha_inicio" class="form-label">Fecha inicio</label>
                        <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_fin" class="form-label">Fecha fin</label>
                        <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" required>
                    </div>
                    <div class="form-text">Selecciona un rango de fechas para el reporte. Si quieres solo un día, pon la misma fecha en ambos campos.</div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download"></i> Descargar PDF
                    </button>
                  </div>
                </form>
              </div>
            </div>

        </div>
    </section>
    <!-- Footer SIEMPRE al fondo -->
    <footer class="footer mt-5">
        <div class="container footer-content">
            <a href="{% url 'control' %}" class="footer-logo">
                <i class="fas fa-industry"></i> Planta Milenio
            </a>
            <p>&copy; 2026 Agrolucha. Todos los derechos reservados.</p>
        </div>
    </footer>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Toast utility
function showToast(message, type="info") {
    const toastId = "toast-" + Math.random().toString(36).substr(2, 9);
    const colors = {
        info: "bg-info text-white",
        danger: "bg-danger text-white",
        success: "bg-success text-white",
        warning: "bg-warning text-dark",
        secondary: "bg-secondary text-white"
    };
    const color = colors[type] || colors.info;
    const toastHtml = `
    <div id="${toastId}" class="toast align-items-center ${color}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>`;
    const container = document.getElementById('toast-container');
    container.insertAdjacentHTML('beforeend', toastHtml);
    const toastElem = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElem);
    toast.show();
    toastElem.addEventListener('hidden.bs.toast', () => toastElem.remove());
}

// Botón cargar datos: si status==2 muestra toast, si no abre modal
function handleCargarDatos(status, modalId) {
    // Leer el valor actual del switch directamente del DOM
    var statusCond = document.getElementById('statusCondSwitch')?.checked ? '1' : '';
    if (statusCond === '1') {
        // Permitir abrir el modal sin importar el status
        var modal = new bootstrap.Modal(document.getElementById(modalId));
        modal.show();
    } else {
        if (status == '2' || status == 2) {
            showToast("Esta orden ya fue ingresada.", "warning");
        } else {
            var modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }
    }
}

// Reloj Venezuela en navbar
function updateVenezuelaClock() {
    // Hora de Venezuela UTC-4
    const now = new Date();
    // Ajuste manual a UTC-4 (Venezuela no tiene horario de verano)
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const venezuela = new Date(utc - (4 * 60 * 60 * 1000));
    const h = venezuela.getHours().toString().padStart(2, '0');
    const m = venezuela.getMinutes().toString().padStart(2, '0');
    const s = venezuela.getSeconds().toString().padStart(2, '0');
    document.getElementById('clock-time').textContent = `${h}:${m}:${s}`;
}
document.addEventListener('DOMContentLoaded', function() {
    updateVenezuelaClock();
    setInterval(updateVenezuelaClock, 1000);
});

function setupAutocomplete(inputId, listId, url, displayFn, valueFn) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    if (!input || !list) return;
    input.addEventListener('input', function() {
        const q = input.value;
        if (q.length < 2) {
            list.innerHTML = '';
            return;
        }
        fetch(url + '?q=' + encodeURIComponent(q))
            .then(resp => resp.json())
            .then(function(data) {
                list.innerHTML = '';
                data.forEach(function(item) {
                    const el = document.createElement('button');
                    el.type = 'button';
                    el.className = 'list-group-item list-group-item-action';
                    el.textContent = displayFn(item);
                    el.onclick = function() {
                        input.value = valueFn(item);
                        list.innerHTML = '';
                    };
                    list.appendChild(el);
                });
            });
    });
    // Cierra el autocompletar si se hace click fuera
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
            list.innerHTML = '';
        }
    });
}

// Llama setupAutocomplete para cada campo
{% if registros %}
    {% regroup registros by fact_num as fact_groups %}
    {% for group in fact_groups %}
        setupAutocomplete('empresaRifInput{{ group.grouper }}', 'empresaRifList{{ group.grouper }}', '{% url "autocomplete_empresa" %}', 
            function(item) { return item.rif + ' - ' + item.nombre; }, function(item) { return item.rif; });
        setupAutocomplete('conductorInput{{ group.grouper }}', 'conductorList{{ group.grouper }}', '{% url "autocomplete_conductor" %}', 
            function(item) { return item.cedula + ' - ' + item.nombre + ' ' + (item.apellido || ''); }, function(item) { return item.cedula; });
        setupAutocomplete('vehiculoInput{{ group.grouper }}', 'vehiculoList{{ group.grouper }}', '{% url "autocomplete_chuto" %}', 
            function(item) { return item.placa + ' - ' + item.nombre; }, function(item) { return item.placa; });
        setupAutocomplete('remolqueInput{{ group.grouper }}', 'remolqueList{{ group.grouper }}', '{% url "autocomplete_tanque" %}', 
            function(item) { return item.placa + ' - ' + item.nombre; }, function(item) { return item.placa; });
        setupAutocomplete('destinoInput{{ group.grouper }}', 'destinoList{{ group.grouper }}', '{% url "autocomplete_destino" %}', 
            function(item) { return item.nombre; }, function(item) { return item.nombre; });
    {% endfor %}
{% endif %}
</script>
<script>
// Limpiar el formulario de consulta sin recargar la página
document.addEventListener('DOMContentLoaded', function() {
    var btnLimpiar = document.getElementById('btnLimpiar');
    var consultaForm = document.getElementById('consultaForm');
    if (btnLimpiar && consultaForm) {
        btnLimpiar.addEventListener('click', function(e) {
            e.preventDefault();
            // Limpiar todos los campos del formulario
            consultaForm.reset();
            // No enviar el formulario automáticamente
        });
    }
    // Al cargar la página, limpia los campos del formulario (opcional, para evitar autocompletado)
    if (consultaForm) {
        consultaForm.reset();
    }
});
</script>
</body>
</html>